@page "/shopping-lists/{MenuId:guid}"
@inject MenuShopper.Services.DataService DataService
@inject NavigationManager Nav
@inject IDialogService DialogService
@inject IJSRuntime JS

<PageTitle>Shopping List</PageTitle>

<MudStack Class="mb-2" Spacing="0">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudText Typo="Typo.h5">Shopping List</MudText>
            <MudChip T="string" Color="Color.Secondary" Variant="Variant.Filled" Size="Size.Small">@RemainingItemCount to get</MudChip>
        </MudStack>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Download"
                       Disabled="@(!_items.Any())" OnClick="ExportItemsAsync">
                Export
            </MudButton>
            <MudCheckBox T="bool" @bind-Value="_skipDeleteConfirmation" Label="Delete without confirmation" />
        </MudStack>
    </MudStack>
    <MudText Typo="Typo.body2" Class="mb-4">@_subtitle</MudText>
</MudStack>

    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudTextField @bind-Value="_newItem"
                          Placeholder="Add extra item"
                          Immediate="true"
                          TextUpdateSuppression="false"
                          OnKeyDown="HandleAddKeyDown" />
            <MudIconButton Icon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary" OnClick="AddItem" />
        </MudStack>
    </MudPaper>

<MudTable Items="_items" Hover="true" Dense="true" RowStyle="padding-top:2px;padding-bottom:2px;" RowStyleFunc="GetRowStyle">
    <HeaderContent>
        <MudTh>Bought</MudTh>
        <MudTh>Item</MudTh>
        <MudTh>From</MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Bought">
            <MudCheckBox T="bool"
                         Value="context.IsBought"
                         ValueChanged="(value) => ToggleBoughtAsync(context, value)" />
        </MudTd>
        <MudTd DataLabel="Item">@context.Ingredient</MudTd>
        <MudTd DataLabel="From">@context.MealNamesText</MudTd>
        <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => DeleteItemAsync(context)" />
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    [Parameter] public Guid MenuId { get; set; }

    private MenuShopper.Models.Menu? _menu;
    private List<MenuShopper.Models.ShoppingListItem> _items = [];
    private string _newItem = string.Empty;
    private string _subtitle = string.Empty;
    private int RemainingItemCount => _items.Count(item => !item.IsBought);
    private bool _skipDeleteConfirmation;

    protected override async Task OnInitializedAsync()
    {
        await DataService.LoadMealsAsync();
        await DataService.LoadMenusAsync();
        _menu = DataService.FindMenuById(MenuId);
        if (_menu == null)
        {
            Nav.NavigateTo("/shopping-lists");
            return;
        }

        _subtitle = $"Menu start date: {_menu.DisplayDate}";
        _items = _menu.ShoppingItems.ToList();
    }

    private async Task ToggleBoughtAsync(MenuShopper.Models.ShoppingListItem item, bool value)
    {
        if (_menu == null)
            return;

        var match = _menu.ShoppingItems.FirstOrDefault(i => i.Id == item.Id);
        if (match == null)
            return;

        match.IsBought = value;
        await DataService.SaveMenuAsync(_menu);
    }

    private string GetRowStyle(MenuShopper.Models.ShoppingListItem item, int rowNumber)
        => item.IsBought ? "text-decoration: line-through; opacity: 0.6;" : string.Empty;

    private async Task AddItem()
    {
        if (_menu == null)
            return;

        var text = _newItem.Trim();
        if (string.IsNullOrWhiteSpace(text))
            return;

        if (_menu.ShoppingItems.Any(i => string.Equals(i.Ingredient, text, StringComparison.OrdinalIgnoreCase)))
            return;

        _menu.ShoppingItems.Add(new MenuShopper.Models.ShoppingListItem
        {
            Ingredient = text,
            MealNames = [],
            IsBought = false,
            IsCustomItem = true
        });

        _newItem = string.Empty;
        await DataService.SaveMenuAsync(_menu);
        _items = _menu.ShoppingItems.ToList();
    }

    private async Task HandleAddKeyDown(KeyboardEventArgs args)
    {
        if ((args.Key == "Enter" || args.Key == "NumpadEnter") && !args.Repeat)
        {
            await AddItem();
            await Task.Delay(100);
            _newItem = string.Empty;
            StateHasChanged();
        }
    }

    private async Task DeleteItemAsync(MenuShopper.Models.ShoppingListItem item)
    {
        if (_menu == null)
            return;

        if (!_skipDeleteConfirmation && !await ConfirmDeleteAsync("Delete item", $"Delete '{item.Ingredient}'?"))
            return;

        _menu.ShoppingItems.RemoveAll(i => i.Id == item.Id);
        await DataService.SaveMenuAsync(_menu);
        _items = _menu.ShoppingItems.ToList();
    }

    private async Task<bool> ConfirmDeleteAsync(string title, string message)
    {
        var options = new MessageBoxOptions
        {
            Title = title,
            Message = message,
            YesText = "Delete",
            CancelText = "Cancel"
        };

        var result = await DialogService.ShowMessageBox(options, new DialogOptions { CloseOnEscapeKey = true });
        return result == true;
    }

    private async Task ExportItemsAsync()
    {
        if (_menu == null || _items.Count == 0)
            return;

        var fileDate = _menu.Date.ToString("yyyy-MM-dd");
        var fileName = $"shopping-list-{fileDate}.txt";
        var lines = _items
            .Select(item => item.Ingredient)
            .Where(text => !string.IsNullOrWhiteSpace(text));
        var content = string.Join(Environment.NewLine, lines);
        await JS.InvokeVoidAsync("menuShopper.downloadTextFile", fileName, content);
    }
}
