@page "/menus/new"
@page "/menus/edit/{MenuId:guid}"
@inject MenuShopper.Services.DataService DataService
@inject NavigationManager Nav

<PageTitle>@PageTitleText</PageTitle>

<MudPaper Class="pa-4 mb-4" Style="position: sticky; top: 64px; z-index: 5; background-color: var(--mud-palette-surface);">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.h5">@PageTitleText</MudText>
            <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small">@_selectedMeals.Count selected</MudChip>
        </MudStack>
        <MudStack Row="true" Spacing="2">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Variant="Variant.Filled" OnClick="Cancel" />
            <MudIconButton Icon="@(_isEdit ? Icons.Material.Filled.Save : Icons.Material.Filled.Check)" Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveMenuAsync" Disabled="@(!_selectedMeals.Any())" />
        </MudStack>
    </MudStack>
    <MudStack>
        <MudDatePicker @bind-Date="_startDate" Label="Start date" />
    </MudStack>
</MudPaper>

<MudPaper Class="pa-4">
    <MudDivider Class="mb-4" />

    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-2">
        <MudText Typo="Typo.subtitle2">Select meals</MudText>
    </MudStack>
    <MudGrid Spacing="2">
        @foreach (var meal in _meals)
        {
            <MudItem xs="12" sm="6" md="4" lg="3" xl="2">
                <MudPaper Class="@GetMealCardClass(meal)" @onclick="() => ToggleMealSelection(meal)">
                    <MudStack Spacing="0">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.subtitle2">@meal.Name</MudText>
                            <MudCheckBox T="bool" Value="@IsMealSelected(meal)"
                                         ValueChanged="(value) => SetMealSelection(meal, value)"
                                         Color="Color.Primary"
                                         Dense="true"
                                         @onclick:stopPropagation="true" />
                        </MudStack>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudChip T="string" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" Class="meal-card-chip">@meal.Category</MudChip>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@meal.IngredientCount</MudText>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>
</MudPaper>

@code {
    [Parameter] public Guid? MenuId { get; set; }

    private MenuShopper.Models.Menu? _menu;
    private List<MenuShopper.Models.Meal> _meals = [];
    private HashSet<MenuShopper.Models.Meal> _selectedMeals = [];
    private DateTime? _startDate = DateTime.Today;
    private bool _isEdit => MenuId.HasValue;
    private string PageTitleText => _isEdit ? "Edit Menu" : "Menu Planning";

    protected override async Task OnInitializedAsync()
    {
        await DataService.LoadMealsAsync();
        _meals = DataService.GetMeals().OrderBy(m => m.Name).ToList();
        if (!_isEdit)
            return;

        await DataService.LoadMenusAsync();
        _menu = DataService.FindMenuById(MenuId!.Value);
        if (_menu == null)
        {
            Nav.NavigateTo("/menus");
            return;
        }

        _startDate = _menu.Date;
        var selectedIds = _menu.MealIds.ToHashSet();
        _selectedMeals = _meals.Where(meal => selectedIds.Contains(meal.Id)).ToHashSet();
    }

    private async Task SaveMenuAsync()
    {
        if (_selectedMeals.Count == 0)
            return;

        if (_menu == null)
        {
            var menu = new MenuShopper.Models.Menu
            {
                Date = _startDate ?? DateTime.Today,
                Meals = _selectedMeals.Select(m => new MenuShopper.Models.MenuMealSelection { MealId = m.Id, IsRescheduled = false }).ToList(),
                IsLocked = true
            };

            menu.ShoppingItems = DataService.GenerateShoppingList(menu);
            await DataService.SaveMenuAsync(menu);
            Nav.NavigateTo($"/shopping-lists/{menu.Id}");
            return;
        }

        _menu.Date = _startDate ?? DateTime.Today;
        _menu.Meals = _selectedMeals.Select(m => new MenuShopper.Models.MenuMealSelection { MealId = m.Id, IsRescheduled = false }).ToList();
        _menu.ShoppingItems = DataService.GenerateShoppingList(_menu);
        await DataService.SaveMenuAsync(_menu);
        Nav.NavigateTo($"/shopping-lists/{_menu.Id}");
    }

    private void Cancel()
    {
        Nav.NavigateTo("/menus");
    }

    private bool IsMealSelected(MenuShopper.Models.Meal meal) => _selectedMeals.Contains(meal);

    private void ToggleMealSelection(MenuShopper.Models.Meal meal)
    {
        if (!_selectedMeals.Add(meal))
            _selectedMeals.Remove(meal);
    }

    private void SetMealSelection(MenuShopper.Models.Meal meal, bool isSelected)
    {
        if (isSelected)
            _selectedMeals.Add(meal);
        else
            _selectedMeals.Remove(meal);
    }

    private string GetMealCardClass(MenuShopper.Models.Meal meal)
    {
        return IsMealSelected(meal)
            ? "meal-card meal-card-selected pa-2"
            : "meal-card pa-2";
    }
}
