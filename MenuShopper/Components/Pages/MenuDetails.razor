@page "/menus/{MenuId:guid}"
@inject MenuShopper.Services.DataService DataService
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Menu Details</PageTitle>

<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
    <MudText Typo="Typo.h5">Menu Details</MudText>
    <MudStack Row="true" Spacing="2">
        <MudIconButton Icon="@Icons.Material.Filled.Edit" Variant="Variant.Filled" Href="@($"/menus/edit/{MenuId}")" />
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Variant="Variant.Filled" OnClick="GoBack" />
    </MudStack>
</MudStack>

<MudPaper Class="pa-4 mb-4">
    <MudGrid Spacing="2">
        <MudItem xs="12" sm="4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudAvatar Square="true" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Medium">
                    <MudIcon Icon="@Icons.Material.Filled.Event" />
                </MudAvatar>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption">Start date</MudText>
                    <MudText Typo="Typo.h6">@_startDate</MudText>
                </MudStack>
            </MudStack>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudAvatar Square="true" Color="Color.Secondary" Variant="Variant.Filled" Size="Size.Medium">
                    <MudIcon Icon="@Icons.Material.Filled.Restaurant" />
                </MudAvatar>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption">Meals</MudText>
                    <MudText Typo="Typo.h6">@_mealCount</MudText>
                </MudStack>
            </MudStack>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudAvatar Square="true" Color="Color.Info" Variant="Variant.Filled" Size="Size.Medium">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" />
                </MudAvatar>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption">Items</MudText>
                    <MudText Typo="Typo.h6">@_itemCount</MudText>
                </MudStack>
            </MudStack>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudPaper Class="pa-4 mb-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
        <MudText Typo="Typo.subtitle1">Emoji list</MudText>
        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.AutoFixHigh"
                       Disabled="_isGenerating" OnClick="GenerateEmojiListAsync">
                Generate
            </MudButton>
            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Variant="Variant.Filled"
                           Disabled="string.IsNullOrWhiteSpace(_emojiListOutput)" OnClick="CopyEmojiListAsync" />
        </MudStack>
    </MudStack>
    @if (_isGenerating)
    {
        <MudProgressLinear Indeterminate="true" Class="mt-2" />
    }
    @if (!string.IsNullOrWhiteSpace(_emojiListOutput))
    {
        <MudPaper Class="pa-3 mt-2" Style="border: 1px solid var(--mud-palette-lines-default); border-radius: var(--mud-default-borderradius);">
            <MudText Typo="Typo.body1" Style="white-space: pre-line; font-family: 'Roboto Mono', monospace;">@_emojiListOutput</MudText>
        </MudPaper>
    }
    @if (!string.IsNullOrWhiteSpace(_copilotError))
    {
        <MudAlert Severity="Severity.Error" Class="mt-2">@_copilotError</MudAlert>
    }
</MudPaper>

<MudDivider Class="my-4" />

<MudTable Items="_meals" Hover="true" Dense="true">
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Category</MudTh>
        <MudTh>Ingredients</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Category">@context.Category</MudTd>
        <MudTd DataLabel="Ingredients">@context.IngredientCount</MudTd>
    </RowTemplate>
</MudTable>

@code {
    [Parameter] public Guid MenuId { get; set; }

    private string _startDate = string.Empty;
    private List<MenuShopper.Models.Meal> _meals = [];
    private int _mealCount;
    private int _itemCount;
    private string _emojiListOutput = string.Empty;
    private string _copilotError = string.Empty;
    private bool _isGenerating;

    private const string EmojiPrompt =
        "Add one appropriate emoji before each menu item name in the list below. Use the exact item text unchanged and include every item exactly once. Output one item per line in the same order as provided. Format: 'ðŸ Spaghetti'. Do not add any other text.";

    protected override async Task OnInitializedAsync()
    {
        await DataService.LoadMealsAsync();
        await DataService.LoadMenusAsync();

        var menu = DataService.FindMenuById(MenuId);
        if (menu == null)
            return;

        _startDate = menu.Date.ToString("yyyy-MM-dd");
        _mealCount = menu.MealIds.Count;
        _itemCount = menu.ShoppingItems.Count;
        _meals = menu.MealIds
            .Select(id => DataService.FindMealById(id))
            .Where(meal => meal != null)
            .Cast<MenuShopper.Models.Meal>()
            .ToList();
    }

    private void GoBack() => Nav.NavigateTo("/menus");

    private async Task GenerateEmojiListAsync()
    {
        if (_isGenerating)
            return;

        if (_meals.Count == 0)
        {
            _copilotError = "No meals found for this menu.";
            return;
        }

        _isGenerating = true;
        _copilotError = string.Empty;
        _emojiListOutput = string.Empty;

        try
        {
            _emojiListOutput = await DataService.SendCopilotPromptAsync(
                BuildEmojiPrompt(),
                "gpt-5.2",
                "high",
                TimeSpan.FromMinutes(3),
                CancellationToken.None);
            if (string.IsNullOrWhiteSpace(_emojiListOutput))
            {
                _copilotError = "No response received.";
                return;
            }

            if (!TryValidateEmojiListOutput(_emojiListOutput, out var validationError))
            {
                _copilotError = validationError;
                _emojiListOutput = string.Empty;
                return;
            }
        }
        catch (Exception ex)
        {
            _copilotError = ex.Message;
        }
        finally
        {
            _isGenerating = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private List<string> GetMealNames()
    {
        return _meals
            .Select(m => m.Name.Trim())
            .Where(name => !string.IsNullOrWhiteSpace(name))
            .OrderBy(name => name, StringComparer.OrdinalIgnoreCase)
            .ToList();
    }

    private string BuildEmojiPrompt()
    {
        var mealNames = GetMealNames();

        return $"{EmojiPrompt}\n{string.Join(Environment.NewLine, mealNames)}";
    }

    private bool TryValidateEmojiListOutput(string output, out string errorMessage)
    {
        var expectedNames = GetMealNames();
        if (expectedNames.Count == 0)
        {
            errorMessage = "No meals found for this menu.";
            return false;
        }

        var expectedSet = new HashSet<string>(expectedNames, StringComparer.OrdinalIgnoreCase);
        var matched = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        var outputLines = output
            .Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

        foreach (var line in outputLines)
        {
            var separatorIndex = line.IndexOf(' ');
            if (separatorIndex <= 0)
                continue;

            var name = line[(separatorIndex + 1)..].Trim();
            if (expectedSet.Contains(name))
                matched.Add(name);
        }

        var missing = expectedNames.Where(name => !matched.Contains(name)).ToList();
        if (missing.Count == 0 && outputLines.Length == expectedNames.Count)
        {
            errorMessage = string.Empty;
            return true;
        }

        if (missing.Count > 0)
        {
            errorMessage = $"Emoji list is missing {missing.Count} meal(s): {string.Join(", ", missing)}. Please generate again.";
            return false;
        }

        errorMessage = "Emoji list contains unexpected items. Please generate again.";
        return false;
    }

    private async Task CopyEmojiListAsync()
    {
        if (string.IsNullOrWhiteSpace(_emojiListOutput))
            return;

        await JS.InvokeVoidAsync("navigator.clipboard.writeText", _emojiListOutput);
    }
}
