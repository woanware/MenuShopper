@page "/menus/{MenuId:guid}"
@inject MenuShopper.Services.DataService DataService
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Menu Details</PageTitle>

<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
    <MudText Typo="Typo.h5">Menu Details</MudText>
    <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Variant="Variant.Filled" OnClick="GoBack" />
</MudStack>

<MudPaper Class="pa-4 mb-4">
    <MudGrid Spacing="2">
        <MudItem xs="12" sm="4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudAvatar Square="true" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Medium">
                    <MudIcon Icon="@Icons.Material.Filled.Event" />
                </MudAvatar>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption">Start date</MudText>
                    <MudText Typo="Typo.h6">@_startDate</MudText>
                </MudStack>
            </MudStack>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudAvatar Square="true" Color="Color.Secondary" Variant="Variant.Filled" Size="Size.Medium">
                    <MudIcon Icon="@Icons.Material.Filled.Restaurant" />
                </MudAvatar>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption">Meals</MudText>
                    <MudText Typo="Typo.h6">@_mealCount</MudText>
                </MudStack>
            </MudStack>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudAvatar Square="true" Color="Color.Info" Variant="Variant.Filled" Size="Size.Medium">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" />
                </MudAvatar>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption">Items</MudText>
                    <MudText Typo="Typo.h6">@_itemCount</MudText>
                </MudStack>
            </MudStack>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudPaper Class="pa-4 mb-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
        <MudText Typo="Typo.subtitle1">Emoji list</MudText>
        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.AutoFixHigh"
                       Disabled="_isGenerating" OnClick="GenerateEmojiListAsync">
                Generate
            </MudButton>
            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Variant="Variant.Filled"
                           Disabled="string.IsNullOrWhiteSpace(_emojiListOutput)" OnClick="CopyEmojiListAsync" />
        </MudStack>
    </MudStack>
    @if (_isGenerating)
    {
        <MudProgressLinear Indeterminate="true" Class="mt-2" />
    }
    <MudTextField Value="_emojiListOutput" ReadOnly="true" Lines="8" FullWidth="true" Variant="Variant.Outlined" Class="mt-2" />
    @if (!string.IsNullOrWhiteSpace(_copilotError))
    {
        <MudAlert Severity="Severity.Error" Class="mt-2">@_copilotError</MudAlert>
    }
</MudPaper>

<MudDivider Class="my-4" />

<MudTable Items="_meals" Hover="true" Dense="true">
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Category</MudTh>
        <MudTh>Ingredients</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Category">@context.Category</MudTd>
        <MudTd DataLabel="Ingredients">@context.IngredientCount</MudTd>
    </RowTemplate>
</MudTable>

@code {
    [Parameter] public Guid MenuId { get; set; }

    private string _startDate = string.Empty;
    private List<MenuShopper.Models.Meal> _meals = [];
    private int _mealCount;
    private int _itemCount;
    private string _emojiListOutput = string.Empty;
    private string _copilotError = string.Empty;
    private bool _isGenerating;

    private const string EmojiPrompt =
        "Here are our meal selections for the week, add appropriate emjois to each one and produce a list, note that the meals are not assigned to any particular day, and sort the list alphabetically";

    protected override async Task OnInitializedAsync()
    {
        await DataService.LoadMealsAsync();
        await DataService.LoadMenusAsync();

        var menu = DataService.FindMenuById(MenuId);
        if (menu == null)
            return;

        _startDate = menu.Date.ToString("yyyy-MM-dd");
        _mealCount = menu.MealIds.Count;
        _itemCount = menu.ShoppingItems.Count;
        _meals = menu.MealIds
            .Select(id => DataService.FindMealById(id))
            .Where(meal => meal != null)
            .Cast<MenuShopper.Models.Meal>()
            .ToList();
    }

    private void GoBack() => Nav.NavigateTo("/menus");

    private async Task GenerateEmojiListAsync()
    {
        if (_isGenerating)
            return;

        if (_meals.Count == 0)
        {
            _copilotError = "No meals found for this menu.";
            return;
        }

        _isGenerating = true;
        _copilotError = string.Empty;
        _emojiListOutput = string.Empty;

        try
        {
            _emojiListOutput = await DataService.SendCopilotPromptAsync(
                BuildEmojiPrompt(),
                "gpt-5.2",
                "high",
                TimeSpan.FromMinutes(3),
                CancellationToken.None);
            if (string.IsNullOrWhiteSpace(_emojiListOutput))
                _copilotError = "No response received.";
        }
        catch (Exception ex)
        {
            _copilotError = ex.Message;
        }
        finally
        {
            _isGenerating = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private string BuildEmojiPrompt()
    {
        var mealNames = _meals
            .Select(m => m.Name)
            .Where(name => !string.IsNullOrWhiteSpace(name));

        return $"{EmojiPrompt}\n{string.Join(Environment.NewLine, mealNames)}";
    }

    private async Task CopyEmojiListAsync()
    {
        if (string.IsNullOrWhiteSpace(_emojiListOutput))
            return;

        await JS.InvokeVoidAsync("navigator.clipboard.writeText", _emojiListOutput);
    }
}
