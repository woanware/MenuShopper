@page "/menus/{MenuId:guid}"
@inject MenuShopper.Services.DataService DataService
@inject NavigationManager Nav

<PageTitle>Menu Details</PageTitle>

<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
    <MudText Typo="Typo.h5">Menu Details</MudText>
    <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Variant="Variant.Filled" OnClick="GoBack" />
</MudStack>

<MudPaper Class="pa-4 mb-4">
    <MudGrid Spacing="2">
        <MudItem xs="12" sm="4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudAvatar Square="true" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Medium">
                    <MudIcon Icon="@Icons.Material.Filled.Event" />
                </MudAvatar>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption">Start date</MudText>
                    <MudText Typo="Typo.h6">@_startDate</MudText>
                </MudStack>
            </MudStack>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudAvatar Square="true" Color="Color.Secondary" Variant="Variant.Filled" Size="Size.Medium">
                    <MudIcon Icon="@Icons.Material.Filled.Restaurant" />
                </MudAvatar>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption">Meals</MudText>
                    <MudText Typo="Typo.h6">@_mealCount</MudText>
                </MudStack>
            </MudStack>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudAvatar Square="true" Color="Color.Info" Variant="Variant.Filled" Size="Size.Medium">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" />
                </MudAvatar>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption">Items</MudText>
                    <MudText Typo="Typo.h6">@_itemCount</MudText>
                </MudStack>
            </MudStack>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudDivider Class="my-4" />

<MudTable Items="_meals" Hover="true" Dense="true">
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Category</MudTh>
        <MudTh>Ingredients</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Category">@context.Category</MudTd>
        <MudTd DataLabel="Ingredients">@context.IngredientCount</MudTd>
    </RowTemplate>
</MudTable>

@code {
    [Parameter] public Guid MenuId { get; set; }

    private string _startDate = string.Empty;
    private List<MenuShopper.Models.Meal> _meals = [];
    private int _mealCount;
    private int _itemCount;

    protected override async Task OnInitializedAsync()
    {
        await DataService.LoadMealsAsync();
        await DataService.LoadMenusAsync();
        var menu = DataService.FindMenuById(MenuId);
        if (menu == null)
            return;

        _startDate = menu.Date.ToString("yyyy-MM-dd");
        _mealCount = menu.MealIds.Count;
        _itemCount = menu.ShoppingItems.Count;
        _meals = menu.MealIds
            .Select(id => DataService.FindMealById(id))
            .Where(meal => meal != null)
            .Cast<MenuShopper.Models.Meal>()
            .ToList();
    }

    private void GoBack() => Nav.NavigateTo("/menus");
}
