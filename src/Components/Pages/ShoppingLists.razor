@page "/shopping-lists"
@inject MenuShopper.Services.DataService DataService
@inject IDialogService DialogService

<PageTitle>Shopping Lists</PageTitle>

<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
    <MudText Typo="Typo.h5">Shopping Lists</MudText>
    <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Variant="Variant.Filled" Href="/menus/new" />
</MudStack>

<MudTable Items="_menus" Hover="true" Dense="true">
    <HeaderContent>
        <MudTh>Start Date</MudTh>
        <MudTh>Items</MudTh>
        <MudTh>Remaining</MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Start Date">@context.DisplayDate</MudTd>
        <MudTd DataLabel="Items">@context.ItemCountText</MudTd>
        <MudTd DataLabel="Remaining">@context.RemainingCountText</MudTd>
        <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart" Href="@($"/shopping-lists/{context.Id}")" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => DeleteMenuAsync(context)" />
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    private List<MenuShopper.Models.Menu> _menus = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        await DataService.LoadMealsAsync();
        await DataService.LoadMenusAsync();
        _menus = DataService.GetMenus().ToList();
    }

    private async Task DeleteMenuAsync(MenuShopper.Models.Menu menu)
    {
        if (!await ConfirmDeleteAsync("Delete menu", $"Delete menu starting {menu.DisplayDate}?"))
            return;

        await DataService.DeleteMenuAsync(menu);
        await LoadAsync();
    }

    private async Task<bool> ConfirmDeleteAsync(string title, string message)
    {
        var options = new MessageBoxOptions
        {
            Title = title,
            Message = message,
            YesText = "Delete",
            CancelText = "Cancel"
        };

        var result = await DialogService.ShowMessageBox(options, new DialogOptions { CloseOnEscapeKey = true });
        return result == true;
    }
}
