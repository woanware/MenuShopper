@page "/shopping-lists/{MenuId:guid}"
@inject MenuShopper.Services.DataService DataService
@inject NavigationManager Nav

<PageTitle>Shopping List</PageTitle>

<MudText Typo="Typo.h5" Class="mb-2">Shopping List</MudText>
<MudText Typo="Typo.body2" Class="mb-4">@_subtitle</MudText>

<MudPaper Class="pa-4 mb-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
        <MudTextField @bind-Value="_newItem" Placeholder="Add extra item" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddItem">Add</MudButton>
    </MudStack>
</MudPaper>

<MudTable Items="_items" Hover="true" Dense="true">
    <HeaderContent>
        <MudTh>Bought</MudTh>
        <MudTh>Item</MudTh>
        <MudTh>From</MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Bought">
            <MudCheckBox T="bool"
                         Value="context.IsBought"
                         ValueChanged="(value) => ToggleBoughtAsync(context, value)" />
        </MudTd>
        <MudTd DataLabel="Item">@context.Ingredient</MudTd>
        <MudTd DataLabel="From">@context.MealNamesText</MudTd>
        <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => DeleteItemAsync(context)" />
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    [Parameter] public Guid MenuId { get; set; }

    private MenuShopper.Models.Menu? _menu;
    private List<MenuShopper.Models.ShoppingListItem> _items = [];
    private string _newItem = string.Empty;
    private string _subtitle = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await DataService.LoadMealsAsync();
        await DataService.LoadMenusAsync();
        _menu = DataService.FindMenuById(MenuId);
        if (_menu == null)
        {
            Nav.NavigateTo("/shopping-lists");
            return;
        }

        _subtitle = $"Menu start date: {_menu.DisplayDate}";
        _items = _menu.ShoppingItems.ToList();
    }

    private async Task ToggleBoughtAsync(MenuShopper.Models.ShoppingListItem item, bool value)
    {
        if (_menu == null)
            return;

        var match = _menu.ShoppingItems.FirstOrDefault(i => i.Id == item.Id);
        if (match == null)
            return;

        match.IsBought = value;
        await DataService.SaveMenuAsync(_menu);
    }

    private async Task AddItem()
    {
        if (_menu == null)
            return;

        var text = _newItem.Trim();
        if (string.IsNullOrWhiteSpace(text))
            return;

        if (_menu.ShoppingItems.Any(i => string.Equals(i.Ingredient, text, StringComparison.OrdinalIgnoreCase)))
            return;

        _menu.ShoppingItems.Add(new MenuShopper.Models.ShoppingListItem
        {
            Ingredient = text,
            MealNames = [],
            IsBought = false,
            IsCustomItem = true
        });

        _newItem = string.Empty;
        await DataService.SaveMenuAsync(_menu);
        _items = _menu.ShoppingItems.ToList();
    }

    private async Task DeleteItemAsync(MenuShopper.Models.ShoppingListItem item)
    {
        if (_menu == null)
            return;

        _menu.ShoppingItems.RemoveAll(i => i.Id == item.Id);
        await DataService.SaveMenuAsync(_menu);
        _items = _menu.ShoppingItems.ToList();
    }
}
