@page "/meals/new"
@page "/meals/edit/{MealId:guid}"
@page "/meals/clone/{CloneId:guid}"
@inject MenuShopper.Services.DataService DataService
@inject NavigationManager Nav
@inject IDialogService DialogService

<PageTitle>@_title</PageTitle>

<MudText Typo="Typo.h5" Class="mb-4">@_title</MudText>

<MudPaper Class="pa-4">
    <MudGrid Spacing="2">
        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="_meal.Name" Label="Meal Name" Required="true" />
        </MudItem>
        <MudItem xs="12" md="6">
            <MudSelect T="string" Label="Category" @bind-Value="_meal.Category" Dense="true">
                @foreach (var category in _categories)
                {
                    <MudSelectItem T="string" Value="@category">@category</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudCheckBox T="bool" @bind-Value="_meal.IsDairy" Label="Contains Dairy" />
        </MudItem>
        <MudItem xs="12" md="6">
            <MudCheckBox T="bool" @bind-Value="_meal.IsFavourite" Label="Favourite" />
        </MudItem>
    </MudGrid>

    <MudDivider Class="my-4" />

    <MudText Typo="Typo.subtitle2" Class="mb-2">Ingredients</MudText>
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
        <MudTextField @bind-Value="_newIngredient"
                      Placeholder="Add ingredient"
                      Immediate="true"
                      TextUpdateSuppression="false"
                      OnKeyDown="HandleIngredientKeyDown" />
        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Variant="Variant.Filled" OnClick="AddIngredient" />
    </MudStack>

    <MudTable Items="_meal.Ingredients" Hover="true" Dense="true">
        <HeaderContent>
            <MudTh>Ingredient</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Ingredient">@context</MudTd>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => RemoveIngredientAsync(context)" />
            </MudTd>
        </RowTemplate>
    </MudTable>

    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2" Class="mt-4">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Variant="Variant.Filled" OnClick="Cancel" />
        @if (!_isNew)
        {
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Variant="Variant.Filled" Color="Color.Error" OnClick="Delete" />
        }
        <MudIconButton Icon="@Icons.Material.Filled.Check" Variant="Variant.Filled" Color="Color.Primary" OnClick="Save" />
    </MudStack>
</MudPaper>

@code {
    [Parameter] public Guid? MealId { get; set; }
    [Parameter] public Guid? CloneId { get; set; }

    private MenuShopper.Models.Meal _meal = new();
    private string _newIngredient = string.Empty;
    private string _title = "Add Meal";
    private bool _isNew = true;
    private List<string> _categories = [];

    protected override async Task OnInitializedAsync()
    {
        await DataService.LoadMealsAsync();
        _categories = await DataService.LoadCategoriesAsync();
        if (_categories.Count == 0)
            _categories = ["Other"];
        if (CloneId.HasValue)
        {
            var source = DataService.FindMealById(CloneId.Value);
            if (source != null)
            {
                _meal = new MenuShopper.Models.Meal
                {
                    Ingredients = source.Ingredients.ToList()
                };
            }
            _title = "Clone Meal";
        }
        else if (MealId.HasValue)
        {
            var existing = DataService.FindMealById(MealId.Value);
            if (existing != null)
            {
                _meal = existing;
                _isNew = false;
                _title = "Edit Meal";
            }
        }
    }

    private void AddIngredient()
    {
        var text = _newIngredient.Trim();
        if (string.IsNullOrWhiteSpace(text))
            return;

        if (_meal.Ingredients.Any(i => string.Equals(i, text, StringComparison.OrdinalIgnoreCase)))
            return;

        _meal.Ingredients.Add(text);
        _newIngredient = string.Empty;
    }

    private async Task HandleIngredientKeyDown(KeyboardEventArgs args)
    {
        if ((args.Key == "Enter" || args.Key == "NumpadEnter") && !args.Repeat)
        {
            AddIngredient();
            await Task.Delay(100);
            _newIngredient = string.Empty;
            StateHasChanged();
        }
    }

    private async Task RemoveIngredientAsync(string ingredient)
    {
        if (!await ConfirmDeleteAsync("Delete ingredient", $"Delete '{ingredient}' from this meal?"))
            return;

        _meal.Ingredients.Remove(ingredient);
    }

    private async Task Save()
    {
        _meal.Name = _meal.Name.Trim();
        _meal.Category = string.IsNullOrWhiteSpace(_meal.Category) ? "Other" : _meal.Category.Trim();
        _meal.Ingredients = _meal.Ingredients
            .Select(i => i.Trim())
            .Where(i => !string.IsNullOrWhiteSpace(i))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(i => i)
            .ToList();

        if (string.IsNullOrWhiteSpace(_meal.Name))
            return;

        if (_isNew)
            await DataService.AddMealAsync(_meal);
        else
            await DataService.UpdateMealAsync(_meal);

        Nav.NavigateTo("/meals");
    }

    private void Cancel() => Nav.NavigateTo("/meals");

    private async Task Delete()
    {
        if (!await ConfirmDeleteAsync("Delete meal", $"Delete '{_meal.Name}'?"))
            return;

        await DataService.DeleteMealAsync(_meal);
        Nav.NavigateTo("/meals");
    }

    private async Task<bool> ConfirmDeleteAsync(string title, string message)
    {
        var options = new MessageBoxOptions
        {
            Title = title,
            Message = message,
            YesText = "Delete",
            CancelText = "Cancel"
        };

        var result = await DialogService.ShowMessageBox(options, new DialogOptions { CloseOnEscapeKey = true });
        return result == true;
    }
}
